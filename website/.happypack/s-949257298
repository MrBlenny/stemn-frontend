'use strict';

angular.module('views.password-reset', []);
angular.module('views.password-reset').config(function ($stateProvider) {
    $stateProvider.state('password-reset', {
        url: '/password-reset?id&token',
        template: require('./password-reset.html'),
        resolve: {
            jwt: function jwt(Authentication, $stateParams) {
                // login via the jwt
                if ($stateParams.id) {
                    return Authentication.setToken($stateParams.id, false);
                }
            }
        },
        controller: function controller(jwt, $stateParams, $scope, $state, $mdToast, SettingsService) {
            $scope.password = {};
            $scope.updatePassword = function () {
                if ($scope.password.newPassword !== $scope.password.confirmPassword) {
                    $mdToast.show($mdToast.simple().theme('warn').content('The passwords you entered don\'t match!'));
                } else {
                    SettingsService.updatePassword($scope.password.oldPassword, $scope.password.newPassword, $stateParams.token).then(function () {
                        // error case is handled by restangular intercepter
                        $mdToast.show($mdToast.simple().content('Great, your password has been updated.'));
                        $state.go('app.home');
                    });
                }
            };
        },
        seo: function seo(resolve) {
            return {
                title: "Change and Reset your Password - STEMN"
            };
        }
    });
});