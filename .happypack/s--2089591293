'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Component = exports.InnerComponent = undefined;

var _index = require('C:\\Users\\david\\repositories\\stemn-electron-2\\node_modules\\redbox-react\\lib\\index.js');

var _index2 = _interopRequireDefault(_index);

var _index3 = require('C:\\Users\\david\\repositories\\stemn-electron-2\\node_modules\\react-transform-catch-errors\\lib\\index.js');

var _index4 = _interopRequireDefault(_index3);

var _react2 = require('react');

var _react3 = _interopRequireDefault(_react2);

var _index5 = require('C:\\Users\\david\\repositories\\stemn-electron-2\\node_modules\\react-transform-hmr\\lib\\index.js');

var _index6 = _interopRequireDefault(_index5);

var _redux = require('redux');

var _reactRedux = require('react-redux');

var _classnames = require('classnames');

var _classnames2 = _interopRequireDefault(_classnames);

var _lodash = require('lodash');

var _moment = require('moment');

var _moment2 = _interopRequireDefault(_moment);

var _FilesActions = require('app/renderer/main/modules/Files/Files.actions.js');

var FilesActions = _interopRequireWildcard(_FilesActions);

var _SyncTimelineActions = require('app/shared/modules/SyncTimeline/SyncTimeline.actions.js');

var SyncTimelineActions = _interopRequireWildcard(_SyncTimelineActions);

var _FileCompareInner = require('app/renderer/main/modules/FileCompare/FileCompareInner/FileCompareInner.jsx');

var _FileCompareInner2 = _interopRequireDefault(_FileCompareInner);

var _Timeline = require('app/renderer/main/modules/Timeline/Timeline.jsx');

var _Timeline2 = _interopRequireDefault(_Timeline);

var _DragResize = require('app/renderer/main/modules/DragResize/DragResize.jsx');

var _DragResize2 = _interopRequireDefault(_DragResize);

var _FileBreadCrumbs = require('app/renderer/main/modules/FileList/components/FileBreadCrumbs.jsx');

var _FileBreadCrumbs2 = _interopRequireDefault(_FileBreadCrumbs);

var _FileCompareMenu = require('app/renderer/main/modules/FileCompare/FileCompareMenu/FileCompareMenu.jsx');

var _FileCompareMenu2 = _interopRequireDefault(_FileCompareMenu);

var _LoadingOverlay = require('app/renderer/main/components/Loading/LoadingOverlay/LoadingOverlay.jsx');

var _LoadingOverlay2 = _interopRequireDefault(_LoadingOverlay);

var _TimelineVertical = require('app/shared/modules/TimelineVertical/TimelineVertical.jsx');

var _TimelineVertical2 = _interopRequireDefault(_TimelineVertical);

var _SimpleTable = require('app/shared/modules/Tables/SimpleTable/SimpleTable.jsx');

var _SimpleTable2 = _interopRequireDefault(_SimpleTable);

var _SectionTitle = require('app/shared/modules/Titles/SectionTitle/SectionTitle.jsx');

var _SectionTitle2 = _interopRequireDefault(_SectionTitle);

var _PagePreview = require('./PagePreview.css');

var _PagePreview2 = _interopRequireDefault(_PagePreview);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var _components = {
  _component: {},
  _component2: {}
};

var _CUsersDavidRepositoriesStemnElectron2Node_modulesReactTransformHmrLibIndexJs2 = (0, _index6.default)({
  filename: 'C:/Users/david/repositories/stemn-electron-2/app/renderer/preview/pages/PreviewPage/PreviewPage.jsx',
  components: _components,
  locals: [module],
  imports: [_react3.default]
});

var _CUsersDavidRepositoriesStemnElectron2Node_modulesReactTransformCatchErrorsLibIndexJs2 = (0, _index4.default)({
  filename: 'C:/Users/david/repositories/stemn-electron-2/app/renderer/preview/pages/PreviewPage/PreviewPage.jsx',
  components: _components,
  locals: [],
  imports: [_react3.default, _index2.default]
});

function _wrapComponent(id) {
  return function (Component) {
    return _CUsersDavidRepositoriesStemnElectron2Node_modulesReactTransformHmrLibIndexJs2(_CUsersDavidRepositoriesStemnElectron2Node_modulesReactTransformCatchErrorsLibIndexJs2(Component, id), id);
  };
} // Container Core


// Container Actions

// Component Core


// Styles


// Functions


// Actions


// Sub Components


// Styles


///////////////////////////////// COMPONENT /////////////////////////////////

var InnerComponent = exports.InnerComponent = _wrapComponent('_component')(_react3.default.createClass({
  displayName: 'InnerComponent',
  getInitialState: function getInitialState() {
    return {
      selected1: this.props.syncTimeline.data[0],
      selected2: null,
      lastSelected: 1,
      mode: 'single'
    };
  },
  onSelect: function onSelect(response) {
    if (this.state.mode == 'single') {
      this.setState({
        selected1: response,
        lastSelected: 1
      });
    } else {
      if (this.state.lastSelected == 1) {
        this.setState({
          selected2: response,
          lastSelected: 2
        });
      } else {
        this.setState({
          selected1: response,
          lastSelected: 1
        });
      }
    }
  },
  changeMode: function changeMode(mode) {
    this.setState({ mode: mode });
  },
  clickCrumb: function clickCrumb(_ref) {
    var file = _ref.file;

    console.log(file);
  },
  isSelected: function isSelected(item) {
    var selected1 = (0, _lodash.has)(this.state, 'selected1.data.revisionId') ? item.data.revisionId == this.state.selected1.data.revisionId : false;
    var selected2 = (0, _lodash.has)(this.state, 'selected2.data.revisionId') ? item.data.revisionId == this.state.selected2.data.revisionId : false;
    return this.state.mode == 'single' ? selected1 : selected1 || selected2;
  },
  render: function render() {
    var _props = this.props;
    var fileMeta = _props.fileMeta;
    var syncTimeline = _props.syncTimeline;
    var _state = this.state;
    var mode = _state.mode;
    var selected1 = _state.selected1;
    var selected2 = _state.selected2;

    var items = mode == 'single' ? [selected1, selected1] : (0, _lodash.orderBy)([selected1, selected2], function (item) {
      return new Date(item.timestamp).getTime();
    });

    var revisions = syncTimeline && syncTimeline.data ? syncTimeline.data.filter(function (item) {
      return item.event == 'revision';
    }) : [];

    return _react3.default.createElement(
      'div',
      { className: 'layout-column flex' },
      _react3.default.createElement(
        'div',
        { className: _PagePreview2.default.header + ' layout-row layout-align-start-center' },
        _react3.default.createElement(
          'div',
          { className: 'flex' },
          fileMeta && fileMeta.data ? _react3.default.createElement(_FileBreadCrumbs2.default, { meta: fileMeta.data, clickFn: this.clickCrumb }) : ''
        ),
        _react3.default.createElement(_FileCompareMenu2.default, {
          file1: items[1].data,
          file2: items[0].data,
          revisions: revisions,
          mode: mode,
          changeMode: this.changeMode
        })
      ),
      _react3.default.createElement(
        'div',
        { className: 'layout-row flex' },
        _react3.default.createElement(
          'div',
          { className: 'layout-column flex' },
          _react3.default.createElement(_FileCompareInner2.default, {
            project: fileMeta.data.project,
            file1: items[1].data,
            file2: items[0].data,
            mode: mode }),
          _react3.default.createElement(_Timeline2.default, { className: _PagePreview2.default.timeline,
            items: revisions,
            onSelect: this.onSelect,
            isSelected: this.isSelected,
            preferPlace: 'above' })
        ),
        _react3.default.createElement(
          _DragResize2.default,
          { side: 'left', width: '450', widthRange: [0, 450], className: 'layout-column' },
          _react3.default.createElement(
            'aside',
            { className: _PagePreview2.default.sidebar + ' flex', style: { minWidth: '400px', overflowY: 'auto' } },
            _react3.default.createElement(
              _SectionTitle2.default,
              { style: { marginBottom: '15px' } },
              'Meta'
            ),
            _react3.default.createElement(
              _SimpleTable2.default,
              null,
              _react3.default.createElement(
                'tr',
                null,
                _react3.default.createElement(
                  'td',
                  null,
                  'Name'
                ),
                _react3.default.createElement(
                  'td',
                  null,
                  fileMeta.data.name
                )
              ),
              _react3.default.createElement(
                'tr',
                null,
                _react3.default.createElement(
                  'td',
                  null,
                  'Size'
                ),
                _react3.default.createElement(
                  'td',
                  null,
                  fileMeta.data.size
                )
              ),
              _react3.default.createElement(
                'tr',
                null,
                _react3.default.createElement(
                  'td',
                  null,
                  'Last modified'
                ),
                _react3.default.createElement(
                  'td',
                  null,
                  (0, _moment2.default)(fileMeta.data.modified).fromNow()
                )
              ),
              _react3.default.createElement(
                'tr',
                null,
                _react3.default.createElement(
                  'td',
                  null,
                  'Revisions'
                ),
                _react3.default.createElement(
                  'td',
                  null,
                  revisions.length
                )
              )
            ),
            _react3.default.createElement(
              _SectionTitle2.default,
              { style: { margin: '30px 0' } },
              'Timeline'
            ),
            _react3.default.createElement(_TimelineVertical2.default, {
              items: syncTimeline && syncTimeline.data ? syncTimeline.data : []
            })
          )
        )
      )
    );
  }
}));

var Component = exports.Component = _wrapComponent('_component2')(_react3.default.createClass({
  displayName: 'Component',


  // Mounting
  onMount: function onMount(nextProps, prevProps) {
    var _nextProps$params = nextProps.params;
    var revisionId = _nextProps$params.revisionId;
    var fileId = _nextProps$params.fileId;
    var projectId = _nextProps$params.projectId;

    // If we do not yet have the meta, get it:

    if (!nextProps.fileMeta || !nextProps.fileMeta.data && !nextProps.fileMeta.loading) {
      nextProps.filesActions.getMeta({ fileId: fileId, revisionId: revisionId });
    }

    // If we don't have the timeline, get it:
    if (!nextProps.syncTimeline || !nextProps.syncTimeline.data && !nextProps.syncTimeline.loading) {
      nextProps.syncTimelineActions.fetchTimeline({ projectId: projectId, fileId: fileId });
    }
  },
  componentWillMount: function componentWillMount() {
    this.onMount(this.props);
  },
  render: function render() {
    var _props2 = this.props;
    var fileMeta = _props2.fileMeta;
    var syncTimeline = _props2.syncTimeline;

    return _react3.default.createElement(
      'div',
      { className: 'layout-column flex' },
      fileMeta && syncTimeline && syncTimeline.data ? _react3.default.createElement(InnerComponent, { fileMeta: fileMeta, syncTimeline: syncTimeline }) : null,
      _react3.default.createElement(_LoadingOverlay2.default, { show: !fileMeta || !syncTimeline })
    );
  }
}));

///////////////////////////////// CONTAINER /////////////////////////////////

function mapStateToProps(_ref2, _ref3) {
  var files = _ref2.files;
  var syncTimeline = _ref2.syncTimeline;
  var params = _ref3.params;

  var cacheKey = params.fileId + '-' + params.revisionId;
  return {
    fileMeta: files.fileMeta[cacheKey],
    syncTimeline: syncTimeline[params.fileId]
  };
}

function mapDispatchToProps(dispatch) {
  return {
    filesActions: (0, _redux.bindActionCreators)(FilesActions, dispatch),
    syncTimelineActions: (0, _redux.bindActionCreators)(SyncTimelineActions, dispatch)
  };
}

exports.default = (0, _reactRedux.connect)(mapStateToProps, mapDispatchToProps)(Component);